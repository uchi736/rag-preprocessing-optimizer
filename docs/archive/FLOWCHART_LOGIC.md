# Preprocessing Optimizer フローチャート形式のロジック説明

## 1. メイン処理フロー

```
[開始]
  ↓
[PDFファイルを開く]
  ↓
[並列処理モード?] ─Yes→ [ThreadPoolExecutor起動]
  │                      ↓
  No                   [各ページを並列タスクに分配]
  ↓                      ↓
[逐次処理]            [並列ページ処理]
  ↓                      ↓
[各ページを順番に処理] ←─┘
  ↓
[結果集約・ソート]
  ↓
[統計情報計算]
  ↓
[結果をJSON保存]
  ↓
[終了]
```

## 2. ページ分析フロー（analyze_page）

```
[ページ分析開始]
  ↓
[段階1: 高速スクリーニング]
  ↓
[スキップパターン?] ─Yes→ [スキップとして終了]
  │
  No
  ↓
[テキスト密度計算]
  ↓
[大型画像検出]
  ↓
[図番号パターン検出]
  ↓
[純粋テキスト?] ─Yes→ [TEXT_ONLYとして終了]
  │
  No
  ↓
[段階2: 詳細分析]
  ↓
[表検出（PyMuPDF）]
  ↓
[図形要素カウント]
  ↓
[テキストパターン分析]
  ↓
[段階3: 処理方法決定]
  ↓
[最適な処理方法を返却]
```

## 3. 図番号検出ロジック

```
[テキスト取得]
  ↓
[図番号パターンマッチング]
  ├─ 図\d+[-\.]\d+
  ├─ 表\d+[-\.]\d+
  └─ Fig.\d+[-\.]\d+
  ↓
[図番号あり?] ─No→ [実際の図なし]
  │
  Yes
  ↓
[参照パターンチェック]
  ├─ "を参照"
  ├─ "に示す"
  ├─ "の通り"
  └─ その他15パターン
  ↓
[参照パターンあり?] ─Yes→ [実際の図なし]
  │
  No
  ↓
[位置パターンチェック]
  ├─ 行頭に図番号?
  ├─ 独立行に図番号?
  └─ 中央揃えの図番号?
  ↓
[いずれか該当?] ─Yes→ [実際の図あり]
  │
  No
  ↓
[実際の図なし]
```

## 4. 処理方法決定ツリー

```
[実際の図あり?]
  │
  ├─Yes→ [表あり?]
  │        ├─Yes→ [COMPLEX_TABLE + IMAGE_WITH_OCR]
  │        └─No→ [図形/画像あり?]
  │                ├─Yes→ [FLOWCHART/DIAGRAM + IMAGE_WITH_ANALYSIS]
  │                └─No→ [DIAGRAM + IMAGE_WITH_ANALYSIS]
  │
  └─No→ [テキスト密度 > 0.7?]
         ├─Yes→ [表なし & 矩形 < 2?]
         │       ├─Yes→ [PURE_TEXT + TEXT_ONLY]
         │       └─No→ [次の判定へ]
         │
         └─No→ [表あり?]
                ├─Yes→ [セル数 > 20?]
                │       ├─Yes→ [COMPLEX_TABLE + IMAGE_WITH_OCR]
                │       └─No→ [SIMPLE_TABLE + STRUCTURED_EXTRACTION]
                │
                └─No→ [フロー図判定]
                       ├─矩形 >= 3 & (ステップor線 > 5)→ [FLOWCHART]
                       ├─大型画像あり→ [DIAGRAM]
                       ├─図形要素あり→ [MIXED + HYBRID]
                       └─その他→ [PURE_TEXT + TEXT_ONLY]
```

## 5. 並列処理フロー

```
[メインスレッド]              [ワーカースレッド1-8]
     ↓                              ↓
[PDFオープン]                  [待機状態]
     ↓                              ↓
[ページタスク作成]             [タスク受信]
     ↓                              ↓
[ThreadPoolに投入] ──────→ [独自のPDF開く]
     ↓                              ↓
[結果待機]                    [ページ分析]
     ↓                              ↓
[as_completed待機]            [処理方法決定]
     ↓                              ↓
[結果受信] ←──────────── [結果返却]
     ↓                              ↓
[次の結果待機]                [PDF閉じる]
     ↓                              ↓
[全結果収集]                  [次のタスク待機]
     ↓
[ページ番号順ソート]
     ↓
[最終結果生成]
```

## 6. メモリ管理フロー

```
[リソース作成]
  ↓
[Pixmap作成時]
  ├─ pix = page.get_pixmap()
  ├─ [処理実行]
  └─ finally: pix = None
  
[Image処理時]
  ├─ with Image.open() as img:
  ├─   [画像処理]
  └─ [自動クローズ]
  
[ドキュメント処理時]
  ├─ doc = fitz.open()
  ├─ [ページ処理]
  └─ doc.close()
```

## 7. エラーハンドリングフロー

```
[処理開始]
  ↓
[try:実行]
  ├─[正常終了]→ [結果返却]
  │
  └─[例外発生]
      ↓
    [エラーレベル判定]
      ├─[ページレベル]
      │   ├─ エラー記録
      │   └─ 処理継続
      │
      ├─[ドキュメントレベル]
      │   ├─ 部分結果生成
      │   └─ エラー情報付加
      │
      └─[システムレベル]
          ├─ エラーメッセージ表示
          ├─ [verbose?]→ スタックトレース
          └─ 終了コード1で終了
```

## 8. コスト計算フロー

```
[ページタイプ判定]
  ↓
[処理方法マッピング]
  ├─ TEXT_ONLY → 0.1
  ├─ STRUCTURED → 0.3
  ├─ IMAGE_OCR → 1.0
  ├─ IMAGE_ML → 1.5
  └─ HYBRID → 0.7
  ↓
[ページコスト集計]
  ↓
[ROI計算]
  ├─ text_value = text_pages × 0.8
  ├─ image_value = image_pages × 0.95
  └─ roi = (value - cost) / cost
  ↓
[結果表示]
```