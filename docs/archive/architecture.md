# 前処理最適化システム アーキテクチャ

## システム構成図

```
┌─────────────────────────────────────────────────────────────┐
│                     PDF入力（整備マニュアル.pdf）                    │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                   Stage 1: 高速スクリーニング                        │
│  ┌─────────────┐ ┌──────────────┐ ┌──────────────┐      │
│  │ テキスト密度計算 │ │ 図番号パターン検出│ │ 大画像の検出   │      │
│  │  (0.1秒/頁)  │ │ 図1-1, 表2-3等│ │ 50000px²以上 │      │
│  └─────────────┘ └──────────────┘ └──────────────┘      │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
                    ┌───────────────┐
                    │ 純粋なテキスト？ │
                    └───────┬───────┘
                       Yes／ │ ＼No
                        ／   │   ＼
                       ▼     │    ▼
              ┌──────────┐  │  ┌────────────────────────────┐
              │テキスト処理│  │  │ Stage 2: 詳細分析          │
              │ (高速)   │  │  │ ・PyMuPDF表検出           │
              └──────────┘  │  │ ・矩形/線分カウント        │
                            │  │ ・STEPパターン検出        │
                            │  └────────────┬───────────────┘
                            │               │
                            │               ▼
                            │      ┌─────────────────┐
                            │      │ Stage 3: 判定   │
                            │      └────────┬────────┘
                            │               │
        ┌───────────────────┼───────────────┴───────────────────┐
        │                   │                                   │
        ▼                   ▼                                   ▼
┌───────────────┐ ┌──────────────────┐             ┌─────────────────┐
│  単純な表      │ │ 複雑な表/フロー図  │             │   混在型         │
│構造化データ抽出│ │   画像化+ML解析   │             │ ハイブリッド処理  │
│ (コスト:0.3)  │ │  (コスト:1.0-1.5) │             │  (コスト:0.7)    │
└───────────────┘ └──────────────────┘             └─────────────────┘
        │                   │                                   │
        └───────────────────┴───────────────────┬───────────────┘
                                                │
                                                ▼
                            ┌─────────────────────────────────┐
                            │         出力結果                 │
                            │ ・テキスト: 4ページ              │
                            │ ・構造化データ: 0ページ           │
                            │ ・画像: 23ページ                │
                            │ ・処理時間: 12.57秒            │
                            └─────────────────────────────────┘
```

## コンポーネント詳細

### 1. PracticalConfig（設定管理）
```python
@dataclass
class PracticalConfig:
    # スクリーニング設定
    quick_text_density_threshold: float = 0.75
    quick_image_size_threshold: int = 50000
    
    # 詳細分析設定
    min_table_cells: int = 8
    complex_table_cell_threshold: int = 30
    
    # 図番号パターン
    figure_number_patterns: List[str]  # 図1-1, 表2-3等
    
    # コスト設定
    text_processing_cost: float = 0.1
    image_processing_cost: float = 1.0
```

### 2. PracticalPageAnalyzer（ページ分析器）
- **責務**: 各ページの内容を分析し、最適な処理方法を決定
- **主要メソッド**:
  - `_quick_screening()`: 高速な初期判定
  - `_detailed_analysis()`: 詳細な図表要素の検出
  - `_determine_processing()`: 処理方法の決定

### 3. PracticalDocumentProcessor（文書処理器）
- **責務**: PDF全体の処理を管理
- **主要メソッド**:
  - `process_pdf()`: メイン処理エントリーポイント
  - `_process_page()`: 個別ページの処理
  - `calculate_roi()`: 投資対効果の計算

## 処理フロー

### 1. 高速スクリーニング（Stage 1）
```
入力: PDFページ
処理:
  1. テキスト密度計算（< 0.1秒）
  2. 図番号パターンマッチング（正規表現）
  3. 大画像の存在確認
出力: 初期分類（pure_text or needs_analysis）
```

### 2. 詳細分析（Stage 2）
```
条件: Stage 1で要分析と判定
処理:
  1. PyMuPDFの表検出API呼び出し
  2. 図形要素（矩形、線分）のカウント
  3. テキストパターン分析（STEP、番号リスト等）
出力: 詳細な特徴量
```

### 3. 処理方法決定（Stage 3）
```
入力: Stage 1, 2の結果
ロジック:
  if 図番号あり:
    → 優先的に画像化
  elif 表あり and セル数 > 30:
    → 複雑な表として画像化
  elif 矩形 >= 3 and 線分あり:
    → フロー図として画像化
  else:
    → テキストまたは構造化処理
出力: 最終的な処理方法
```

## パフォーマンス特性

| 処理タイプ | 1ページあたり時間 | メモリ使用量 | 出力サイズ |
|-----------|-----------------|------------|-----------|
| テキスト処理 | 0.1秒 | 低（1MB） | 小（1-10KB） |
| 構造化抽出 | 0.3秒 | 中（5MB） | 中（10-50KB） |
| 画像化（200DPI） | 0.5秒 | 高（20MB） | 大（100KB-1MB） |

## 拡張ポイント

### 1. 新しい図表パターンの追加
```python
config.figure_number_patterns.append(r'Chart\s*\d+')
```

### 2. 処理方法のカスタマイズ
```python
class CustomProcessor(PracticalDocumentProcessor):
    def _process_page(self, page, page_num, analysis, output_dir):
        # カスタム処理ロジック
        pass
```

### 3. 出力形式の拡張
- JSON-LD形式での構造化データ出力
- GraphMLでのフロー図表現
- マルチモーダルLLM用のプロンプト生成

## まとめ

このアーキテクチャにより、以下を実現：
1. **高速性**: 必要なページのみ詳細分析
2. **精度**: 図番号パターンで重要な図表を見逃さない
3. **効率性**: 処理方法を最適化してコスト削減
4. **拡張性**: 新しいパターンや処理方法を容易に追加可能